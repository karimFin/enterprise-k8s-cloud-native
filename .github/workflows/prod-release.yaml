name: Prod Release

on:
  push:
    branches: [prod]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: http://207.127.93.80
    steps:
      - uses: actions/checkout@v4
      - name: Install OCI CLI
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install oci-cli
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Configure OCI CLI
        shell: bash
        env:
          OCI_CONFIG: ${{ secrets.OCI_CONFIG }}
          OCI_API_KEY: ${{ secrets.OCI_API_KEY }}
        run: |
          mkdir -p $HOME/.oci
          if [ -z "$OCI_CONFIG" ] || [ -z "$OCI_API_KEY" ]; then
            echo "OCI_CONFIG or OCI_API_KEY is not set"
            exit 1
          fi
          if echo "$OCI_CONFIG" | grep -q '\[DEFAULT\]'; then
            printf '%s\n' "$OCI_CONFIG" > $HOME/.oci/config
          else
            if echo "$OCI_CONFIG" | base64 -d > $HOME/.oci/config 2>/dev/null || echo "$OCI_CONFIG" | base64 --decode > $HOME/.oci/config 2>/dev/null; then
              true
            else
              printf '%s\n' "$OCI_CONFIG" > $HOME/.oci/config
            fi
          fi
          if echo "$OCI_API_KEY" | grep -q 'BEGIN RSA PRIVATE KEY'; then
            printf '%s\n' "$OCI_API_KEY" > $HOME/.oci/oci_api_key.pem
          else
            if echo "$OCI_API_KEY" | base64 -d > $HOME/.oci/oci_api_key.pem 2>/dev/null || echo "$OCI_API_KEY" | base64 --decode > $HOME/.oci/oci_api_key.pem 2>/dev/null; then
              true
            else
              printf '%s\n' "$OCI_API_KEY" > $HOME/.oci/oci_api_key.pem
            fi
          fi
          if grep -q '^key_file=' $HOME/.oci/config; then
            sed -i.bak "s|^key_file=.*|key_file=$HOME/.oci/oci_api_key.pem|" $HOME/.oci/config
          else
            echo "key_file=$HOME/.oci/oci_api_key.pem" >> $HOME/.oci/config
          fi
          chmod 600 $HOME/.oci/oci_api_key.pem
      - uses: imranismail/setup-kustomize@v2
      - uses: azure/setup-kubectl@v4
        with:
          version: v1.34.2
      - name: Configure kubeconfig
        shell: bash
        env:
          RAW_KUBECONFIG: ${{ secrets.KUBE_CONFIG_PROD }}
        run: |
          mkdir -p $HOME/.kube
          if [ -z "$RAW_KUBECONFIG" ]; then
            echo "KUBE_CONFIG_PROD is not set"
            exit 1
          fi
          if echo "$RAW_KUBECONFIG" | grep -q 'apiVersion:'; then
            echo "$RAW_KUBECONFIG" > $HOME/.kube/config
          else
            echo "$RAW_KUBECONFIG" | base64 -d > $HOME/.kube/config || echo "$RAW_KUBECONFIG" | base64 --decode > $HOME/.kube/config
          fi
          if grep -Eq 'server:\s*https?://(127\.0\.0\.1|localhost)' $HOME/.kube/config; then
            echo "KUBE_CONFIG_PROD points to localhost. Use a real cluster kubeconfig."
            exit 1
          fi
      - name: Verify cluster access
        run: kubectl cluster-info
      - name: Deploy prod
        shell: bash
        run: |
          OWNER_LOWER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          IMAGE_BACKEND=ghcr.io/${OWNER_LOWER}/myapp-backend
          IMAGE_FRONTEND=ghcr.io/${OWNER_LOWER}/myapp-frontend
          IMAGE_SHA=${{ github.sha }}
          cd k8s/overlays/prod
          kustomize edit set image \
            backend=${IMAGE_BACKEND}:${IMAGE_SHA} \
            frontend=${IMAGE_FRONTEND}:${IMAGE_SHA}
          kustomize build . | kubectl apply -f -
          kubectl rollout status deployment/backend -n myapp-production --timeout=600s
          kubectl rollout status deployment/frontend -n myapp-production --timeout=600s
